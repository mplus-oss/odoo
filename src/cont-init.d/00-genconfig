#!/usr/bin/env python3

from os import environ, mkdir
from os.path import isdir, isfile, dirname
from sys import exit, stderr

odoo_conf_path = environ.get("ODOOCONF", "/opt/odoo/etc/odoo.conf")
config = {}

for e, value in environ.items():
    if e.startswith("ODOOCONF__"):
        try:
            section = e.split("__")[1]
            key = e.split("__")[2]
        except IndexError:
            print("ERROR: Invalid environment variable: {}".format(e), file=stderr)
            continue
        if section not in config:
            config[section] = {}
        config[section][key] = value

if isdir(odoo_conf_path):
    print(f"ERROR: {odoo_conf_path} is a directory", file=stderr)
    exit(1)

if not isdir(dirname(odoo_conf_path)):
    mkdir(dirname(odoo_conf_path))

if isfile(odoo_conf_path):
    print(f"NOTICE: {odoo_conf_path} already exists, skipping config generation", file=stderr)
    exit(0)

header = '''; This configuration file is generated by 00-genconfig
; by parsing environment variables.

'''

with open(odoo_conf_path, "w") as f:
    f.write(header)
    for section, keys in sorted(config.items()):
        f.write(f"[{section}]\n")
        for key, value in sorted(keys.items()):
            f.write(f"{key} = {value}\n")
        f.write("\n")
